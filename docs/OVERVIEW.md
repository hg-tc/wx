# 项目概览

## 🎯 项目简介

企业微信智能客服系统是一个基于 FastAPI 和企业微信客服 API 的智能客服解决方案，集成了 AI 对话、服务发布匹配、商品比价等功能。

## 🏗️ 架构设计

### 系统架构

```
┌─────────────┐
│  微信用户   │
└──────┬──────┘
       │
       ↓
┌─────────────────────────┐
│   企业微信客服 API      │
│   (Webhook 回调)        │
└──────────┬──────────────┘
           │
           ↓
┌──────────────────────────────────────┐
│         FastAPI 应用服务器            │
│  ┌────────────────────────────────┐  │
│  │     Webhook 处理模块           │  │
│  │  - 消息解密                    │  │
│  │  - 事件分发                    │  │
│  └───────────┬────────────────────┘  │
│              │                        │
│  ┌───────────┴────────────────────┐  │
│  │      AI 对话引擎               │  │
│  │  - 意图识别                    │  │
│  │  - 上下文管理                  │  │
│  │  - DeepSeek API 集成           │  │
│  └───────────┬────────────────────┘  │
│              │                        │
│  ┌───────────┴────────────────────┐  │
│  │      业务逻辑层                │  │
│  │  - 服务发布/匹配               │  │
│  │  - 商品比价                    │  │
│  │  - 用户管理                    │  │
│  └───────────┬────────────────────┘  │
│              │                        │
│  ┌───────────┴────────────────────┐  │
│  │      数据访问层                │  │
│  │  - SQLAlchemy ORM              │  │
│  │  - 向量检索 (pgvector)         │  │
│  └────────────────────────────────┘  │
└──────────────┬───────────────────────┘
               │
       ┌───────┴────────┐
       ↓                ↓
┌──────────────┐  ┌──────────────┐
│  PostgreSQL  │  │    Redis     │
│  + pgvector  │  │  (可选)      │
└──────────────┘  └──────────────┘
```

### 模块说明

#### 1. 企业微信集成层 (`app/wecom/`)

- **kf_client.py**: 客服 API 客户端
  - 消息发送
  - 会话状态管理
  - Token 管理
  
- **webhook.py**: Webhook 处理器
  - 消息解密
  - 签名验证
  - 事件解析

- **message_builder.py**: 消息构建器
  - 文本消息
  - 卡片消息
  - 图文消息

#### 2. AI 引擎层 (`app/ai_engine/`)

- **deepseek_client.py**: DeepSeek API 客户端
  - 对话补全
  - 流式响应
  
- **intent_classifier.py**: 意图识别
  - 服务发布
  - 服务查找
  - 商品比价
  - 闲聊

- **dialogue_manager.py**: 对话管理
  - 上下文保持
  - 多轮对话
  - 状态机

- **embedding_service.py**: 向量嵌入
  - 文本向量化
  - 语义相似度计算

#### 3. 业务逻辑层

##### 服务中介 (`app/service_broker/`)
- **service_manager.py**: 服务管理
- **matcher.py**: 服务匹配引擎
- **recommender.py**: 服务推荐
- **notification.py**: 通知服务

##### 电商爬虫 (`app/ecommerce_crawler/`)
- **taobao_api.py**: 淘宝开放 API
- **xianyu_crawler.py**: 闲鱼爬虫
- **price_comparator.py**: 价格对比

#### 4. 数据模型层 (`app/models/`)

- **user.py**: 用户模型
  - 内部员工 (internal)
  - 外部客户 (external)
  
- **service.py**: 服务模型
  - 服务信息
  - 向量嵌入
  
- **conversation.py**: 对话模型
  - 对话历史
  - 上下文数据
  
- **product.py**: 商品模型
  - 商品信息
  - 价格历史

#### 5. API 路由层 (`app/api/v1/`)

- **wecom.py**: 企业微信回调接口
- **services.py**: 服务管理接口
- **shopping.py**: 比价购物接口
- **admin.py**: 管理后台接口

## 🔄 核心流程

### 1. 消息接收流程

```
用户发送消息
    ↓
企业微信推送到 /api/v1/wecom/callback
    ↓
验证签名并解密消息
    ↓
提取消息内容和用户ID
    ↓
查询/创建用户记录
    ↓
检查会话状态 (service_state)
    ↓
分发到对应处理器
```

### 2. AI 对话流程

```
接收用户消息
    ↓
意图识别 (intent_classifier)
    ↓
┌─────────┬─────────┬─────────┬─────────┐
│ 发布服务│ 查找服务│ 比价购物│   闲聊  │
└────┬────┴────┬────┴────┬────┴────┬────┘
     │         │         │         │
     ↓         ↓         ↓         ↓
  提取实体  向量检索  启动爬虫  DeepSeek
     │         │         │         │
     └─────────┴─────────┴─────────┘
               ↓
          生成响应
               ↓
          发送给用户
               ↓
          保存对话历史
```

### 3. 服务匹配流程

```
用户发布服务需求
    ↓
提取关键信息 (标题、描述、类别、价格)
    ↓
生成向量嵌入
    ↓
存储到数据库
    ↓
触发匹配任务 (Celery)
    ↓
向量相似度搜索
    ↓
找到匹配的服务
    ↓
推送通知给双方
```

### 4. 比价购物流程

```
用户输入商品名称
    ↓
并行调用多个平台爬虫
    ↓
┌─────────┬─────────┬─────────┐
│  淘宝   │  闲鱼   │  京东   │
└────┬────┴────┬────┴────┬────┘
     │         │         │
     └─────────┴─────────┘
               ↓
          聚合结果
               ↓
          价格排序
               ↓
          格式化消息
               ↓
          发送给用户
```

## 📊 数据库设计

### 主要表结构

#### users (用户表)
```sql
- id: UUID (主键)
- wecom_user_id: 企业微信用户ID
- external_userid: 外部客户ID
- nickname: 昵称
- user_type: 用户类型 (internal/external)
- created_at: 创建时间
```

#### services (服务表)
```sql
- id: UUID (主键)
- user_id: 发布者ID
- title: 服务标题
- description: 服务描述
- category: 服务分类
- price: 价格
- embedding: 向量嵌入 (vector)
- status: 状态 (active/matched/closed)
- created_at: 创建时间
```

#### conversations (对话表)
```sql
- id: UUID (主键)
- user_id: 用户ID
- role: 角色 (user/assistant)
- content: 对话内容
- intent: 意图
- entities: 实体 (JSONB)
- created_at: 创建时间
```

#### products (商品表)
```sql
- id: UUID (主键)
- name: 商品名称
- platform: 平台
- price: 价格
- url: 链接
- metadata: 元数据 (JSONB)
- crawled_at: 爬取时间
```

## 🔐 安全设计

### 1. 消息加密
- 企业微信消息使用 AES 加密
- EncodingAESKey 配置验证

### 2. 签名验证
- 所有 Webhook 请求验证签名
- Token 和时间戳校验

### 3. 数据安全
- 数据库连接加密
- 敏感信息环境变量管理
- API Key 安全存储

### 4. 访问控制
- IP 白名单限制
- 用户权限管理

## 🚀 性能优化

### 1. 缓存策略
- Redis 缓存 access_token
- 对话历史缓存
- 向量检索结果缓存

### 2. 异步处理
- 所有 I/O 操作异步化
- 爬虫任务队列化 (Celery)
- 批量处理优化

### 3. 数据库优化
- 向量索引优化 (pgvector HNSW)
- 查询语句优化
- 连接池管理

### 4. API 限流
- 企业微信 API 频率控制
- 重试机制
- 熔断保护

## 🔧 配置管理

### 环境变量
所有配置通过 `.env` 文件管理：
- 数据库连接
- 企业微信凭证
- AI API 密钥
- 应用配置

### 配置类 (`app/config.py`)
使用 `pydantic-settings` 管理配置：
- 类型验证
- 默认值设置
- 环境变量映射

## 📈 监控和日志

### 日志系统
- 结构化日志 (loguru)
- 日志分级 (DEBUG/INFO/WARNING/ERROR)
- 日志轮转 (按日期)

### 监控指标
- API 响应时间
- 错误率
- 消息处理量
- 数据库性能

## 🔮 扩展性

### 水平扩展
- 无状态设计
- 支持多实例部署
- 负载均衡

### 垂直扩展
- 模块化设计
- 插件化架构
- 易于添加新功能

### 第三方集成
- 标准化 API 接口
- Webhook 机制
- SDK 支持

## 📚 相关文档

- [README](../README.md) - 项目介绍
- [安装配置指南](SETUP.md) - 详细安装步骤
- [API 文档](API.md) - API 接口说明
- [故障排查](TROUBLESHOOTING.md) - 问题解决
- [贡献指南](../CONTRIBUTING.md) - 如何贡献

