# 🔧 解决 state=3 无法发送消息的问题

## 🎯 问题根源

### 官方文档说明

根据[企业微信官方文档](https://developer.work.weixin.qq.com/document/path/94677)：

> **发送消息 POST /cgi-bin/kf/send_msg**
> 
> 概述：当微信客户处于"**新接入待处理**"或"**由智能助手接待**"状态下，可调用该接口给用户发送消息。

### API发送限制

| service_state | 状态名称 | send_msg API | 说明 |
|--------------|---------|--------------|------|
| **0** | 新接入待处理 | ✅ **可以** | 未分配接待方 |
| **1** | 智能助手接待 | ✅ **可以** | 由智能助手/机器人接待 |
| **2** | 待接入池排队 | ❌ 不可以 | 在队列中等待 |
| **3** | 人工接待中 | ❌ **不可以** | 由人工客服接待 |
| **4** | 已结束 | ❌ 不可以 | 会话结束 |

---

## 🔍 你的情况

### 当前状态

```log
📊 当前会话状态: 人工接待中 (state=3) | 接待人: ZhangSuQuan
```

### 错误信息

```json
{
  "errcode": 95018,
  "errmsg": "send msg session status invalid"
}
```

### 原因

**会话一进来就是 state=3（人工接待），所以 `send_msg` API 无法发送消息！**

---

## 💡 为什么会话是 state=3？

### 企业微信后台配置决定初始状态

```
后台配置              →  新会话进入状态
─────────────────────────────────────
仅智能助手接待        →  state=1 ✅ API可发送
智能助手接待优先      →  state=1 ✅ API可发送
人工接待优先          →  state=3 ❌ API不可发送
仅人工接待            →  state=3 ❌ API不可发送
自动分配给接待人员    →  state=3 ❌ API不可发送
```

**你的后台配置了"人工接待"相关模式，所以新会话自动分配给 ZhangSuQuan，进入 state=3。**

---

## ✅ 解决方案

### 🎯 方案1：改为智能助手接待（推荐）

#### 步骤1：登录企业微信管理后台

访问：https://work.weixin.qq.com/

#### 步骤2：进入微信客服设置

```
企业微信管理后台
  ↓
应用管理
  ↓
微信客服（你的客服应用）
  ↓
接待设置 / 智能助手设置
```

#### 步骤3：修改接待模式

**选择以下任一配置：**

##### 选项A：仅智能助手接待（最简单）✅

```
接待模式：
  ○ 人工接待优先
  ○ 智能助手接待优先
  ● 仅智能助手接待  ← 选这个
```

**效果**：
- 所有新会话进入 state=1
- API 可以自动回复
- 不需要配置接待人员

##### 选项B：智能助手接待优先

```
接待模式：
  ○ 人工接待优先
  ● 智能助手接待优先  ← 选这个
  ○ 仅智能助手接待
```

**效果**：
- 新会话首先进入 state=1（智能助手）
- API 可以自动回复
- 必要时可以转人工

#### 步骤4：保存配置

点击【保存】或【确定】

#### 步骤5：测试

1. 重新关注或重新进入客服会话
2. 发送消息 "你好"
3. 查看应用日志

**预期日志**：

```log
📊 当前会话状态: 智能助手接待 (state=1)  ← state=1！
🤖 AI响应: 您好！...
✅ 成功发送客服消息
```

---

### 🔄 方案2：通过API转换状态（复杂，不推荐）

理论上可以通过 `service_state_trans` API 将 state=3 转为 state=1，但：

**问题**：
- 需要 servicer_userid（接待人员权限）
- 可能有转换限制（95016错误）
- 逻辑复杂

**不推荐**，建议使用方案1。

---

## 📋 验证步骤

### 1. 修改后台配置

按照上述步骤修改为"仅智能助手接待"

### 2. 重启应用（确保使用最新代码）

```bash
cd /root/wx
source venv/bin/activate
pkill -f "uvicorn.*app.main:app"
sleep 2
nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload > logs/uvicorn.log 2>&1 &
```

### 3. 启动日志监控

```bash
tail -f logs/app_*.log | grep -E "会话状态|发送"
```

### 4. 测试新会话

**重要**：需要**创建新会话**，旧会话的状态不会改变。

- 删除或退出当前客服会话
- 重新进入客服
- 发送测试消息

### 5. 查看日志

**预期输出**：

```log
📊 当前会话状态: 智能助手接待 (state=1)
💬 客服消息内容: 你好
🤖 AI响应: 您好！我是智能助手...
✅ 成功发送客服消息
```

---

## 🎓 总结

### 关键点

1. **send_msg API 只支持 state=0 和 state=1**
2. **state=3（人工接待）无法使用 send_msg API**
3. **后台配置决定新会话的初始状态**
4. **需要配置为"智能助手接待"模式**

### 流程图

```
用户发送消息
    ↓
企业微信判断接待模式
    ↓
后台配置：仅智能助手接待
    ↓
会话进入 state=1
    ↓
send_msg API 可以发送 ✅
    ↓
用户收到自动回复
```

vs

```
用户发送消息
    ↓
企业微信判断接待模式
    ↓
后台配置：人工接待优先
    ↓
会话进入 state=3（分配给ZhangSuQuan）
    ↓
send_msg API 无法发送 ❌
    ↓
返回 95018 错误
```

---

## 🔗 参考文档

- [发送客服消息 - 企业微信官方文档](https://developer.work.weixin.qq.com/document/path/94677)
- [变更会话状态](https://developer.work.weixin.qq.com/document/path/94669)
- [获取会话状态](https://developer.work.weixin.qq.com/document/path/94669)

---

## ⚠️ 常见问题

### Q: 改了配置，还是 state=3？

A: 旧会话的状态不会改变，需要**创建新会话**。退出客服重新进入。

### Q: 不想用智能助手，只想人工？

A: 那就无法使用 `send_msg` API 自动回复。state=3 时只能由接待人员（ZhangSuQuan）手动回复。

### Q: 可以先智能助手，再转人工吗？

A: 可以！配置"智能助手接待优先"，然后在需要时通过API或手动转人工。

---

**修改后台配置为"仅智能助手接待"，就能解决95018错误！** 🎉

